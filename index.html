<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Link French v1.0</title>
    
    <meta name="theme-color" content="#EF4135">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‡«ğŸ‡·</text></svg>">
    <link rel="manifest" id="my-manifest">

    <style>
        /* --- Base Styles (Theme: Tricolore Blue/Red) --- */
        :root {
            --primary: #0055A4; /* French Blue */
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --subtext: #64748b;
            --border: #e2e8f0; --accent: #EF4135; /* French Red */
            --danger: #ef4444; --success: #10b981;
            --cat-bus: #dbeafe; --cat-bus-t: #1e40af; --cat-day: #dcfce7; --cat-day-t: #166534;
            --cat-trv: #fce7f3; --cat-trv-t: #9d174d; --cat-base: #ffedd5; --cat-base-t: #9a3412;
            --status-done: #dcfce7; --status-done-t: #166534;
            --tab-active-bg: #eff6ff; --tab-active-t: #0055A4;
        }
        [data-theme="dark"] {
            --primary: #60a5fa; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --subtext: #94a3b8;
            --border: #334155; --cat-bus: #1e3a8a; --cat-bus-t: #dbeafe; --cat-day: #14532d; --cat-day-t: #dcfce7;
            --cat-trv: #831843; --cat-trv-t: #fce7f3; --cat-base: #7c2d12; --cat-base-t: #ffedd5;
            --status-done: #064e3b; --status-done-t: #6ee7b7;
            --tab-active-bg: #1e293b; --tab-active-t: #60a5fa;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overscroll-behavior: none; }
        
        header { background-color: var(--card); border-bottom: 1px solid var(--border); padding: 0.8rem; display: flex; justify-content: space-between; align-items: center; padding-top: env(safe-area-inset-top); z-index: 10;}
        .app-title { font-weight: bold; font-size: 1.1rem; }
        .theme-toggle { background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        
        .bottom-nav { display: flex; background: var(--card); border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; padding: 12px; text-align: center; font-size: 0.7rem; color: var(--subtext); cursor: pointer; border-top: 3px solid transparent; }
        .nav-item.active { color: var(--primary); border-top-color: var(--primary); font-weight: bold; }
        .nav-icon { display: block; font-size: 1.4rem; margin-bottom: 2px; }

        main { flex: 1; overflow-y: auto; padding: 1rem; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        .card { background: var(--card); border-radius: 12px; padding: 1.2rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .btn { background-color: var(--primary); color: white; border: none; padding: 12px 16px; border-radius: 8px; font-size: 0.95rem; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; width: 100%; box-sizing: border-box; font-weight: 600; }
        .btn:active { opacity: 0.9; transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-accent { background-color: var(--accent); color: #fff; }
        .btn-success { background-color: var(--success); color: white; }

        .list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; background: var(--card); margin-bottom: 8px; border-radius: 8px; border: 1px solid var(--border); }
        .list-content { flex: 1; }
        .list-summary { font-weight: bold; font-size: 1rem; margin-bottom: 5px; }
        .list-meta { display: flex; gap: 8px; align-items: center; font-size: 0.8rem; flex-wrap: wrap; }
        .cat-tag { padding: 2px 8px; border-radius: 10px; font-weight: 600; font-size: 0.75rem; }
        .level-tag { font-size: 0.7rem; padding: 1px 6px; border: 1px solid var(--border); border-radius: 4px; color: var(--subtext); }
        .cat-Business { background: var(--cat-bus); color: var(--cat-bus-t); } .cat-Daily { background: var(--cat-day); color: var(--cat-day-t); }
        .cat-Travel { background: var(--cat-trv); color: var(--cat-trv-t); } .cat-Basic { background: var(--cat-base); color: var(--cat-base-t); }
        .progress-badges { display: flex; gap: 5px; margin-left: auto; }
        .p-badge { font-size: 0.8rem; padding: 3px 6px; border-radius: 4px; background: var(--border); color: var(--subtext); opacity: 0.5; filter: grayscale(100%); transition: 0.3s; }
        .p-badge.done { background: var(--status-done); color: var(--status-done-t); opacity: 1; filter: grayscale(0%); font-weight: bold; border: 1px solid var(--status-done-t); }

        .lesson-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .lesson-tabs { display: flex; background: var(--bg); padding: 4px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 15px; }
        .l-tab { flex: 1; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--subtext); transition: 0.2s; font-size: 0.95rem; }
        .l-tab.active { background: var(--card); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .lesson-content { display: none; animation: fadeIn 0.3s ease; }
        .lesson-content.active { display: block; }

        .text-fr { font-size: 1.2rem; line-height: 1.6; margin: 15px 0; white-space: pre-wrap; }
        .text-jp { color: var(--subtext); font-size: 0.95rem; margin-top: 10px; border-top: 1px dashed var(--border); padding-top: 10px; }
        .chunk-view { line-height: 2; font-size: 1.1rem; } .chunk-sep { color: var(--subtext); opacity: 0.3; margin: 0 4px; }
        
        .pattern-box { text-align: center; padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); }
        .pattern-key { font-size: 1.4rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .drill-card { border-top: 1px solid var(--border); padding-top: 15px; margin-top: 15px; }
        .btn-mic { background: var(--bg); border: 1px solid var(--subtext); color: var(--text); }
        .btn-mic.listening { background: var(--danger); color: white; border-color: var(--danger); animation: pulse 1.5s infinite; }
        .score-box { margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 6px; font-size: 0.9rem; }
        .word-ok { color: var(--success); font-weight: bold; }
        .word-miss { color: var(--danger); text-decoration: line-through; opacity: 0.6; }

        input[type=range] { flex: 1; margin: 0 10px; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-col { flex: 1; }
        label { font-size: 0.75rem; color: var(--subtext); font-weight: bold; display: block; margin-bottom: 3px; }
        textarea, input[type=text], input[type=number], select { width: 100%; padding: 8px; border-radius: 6px; background: var(--bg); color: var(--text); border: 1px solid var(--border); box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }

        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div class="app-title">Link French v1.0</div>
    <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
</header>

<main id="app-content"></main>

<div class="bottom-nav">
    <div class="nav-item active" id="nav-list" onclick="setMode('list')">
        <span class="nav-icon">ğŸ“‚</span>List
    </div>
    <div class="nav-item" id="nav-test" onclick="startTest()">
        <span class="nav-icon">ğŸ¯</span>Test
    </div>
    <div class="nav-item" id="nav-config" onclick="setMode('settings')">
        <span class="nav-icon">âš™ï¸</span>Config
    </div>
</div>

<script>
// --- SERVICE WORKER ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Failed', err));
    });
}

// --- CORE ---
const manifest = { "name": "Link French", "short_name": "LinkFr", "start_url": ".", "display": "standalone", "background_color": "#f8fafc", "theme_color": "#0055A4", "icons": [{ "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‡«ğŸ‡·</text></svg>", "sizes": "512x512", "type": "image/svg+xml" }] };
document.getElementById('my-manifest').setAttribute('href', 'data:application/manifest+json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest)));

// ãƒ•ãƒ©ãƒ³ã‚¹èªã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿
const defaultData = [
  { 
      "id": "fr1", "category": "Basic", "level": "Beginner",
      "progress": { "listen": false, "speak": false },
      "commute_content": { 
          "french_text": "Je voudrais un cafÃ©, s'il vous plaÃ®t. Et aussi un croissant.", 
          "japanese_translation": "ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’1ã¤ãŠé¡˜ã„ã—ã¾ã™ã€‚ã‚ã¨ã‚¯ãƒ­ãƒ¯ãƒƒã‚µãƒ³ã‚‚ã€‚", 
          "chunks": "Je voudrais / un cafÃ©, / s'il vous plaÃ®t. / Et aussi / un croissant.", 
          "summary": "ã‚«ãƒ•ã‚§ã§ã®æ³¨æ–‡", 
          "vocabulary": [{ "word": "Je voudrais", "meaning": "ã€œãŒæ¬²ã—ã„ã®ã§ã™ãŒ" }, { "word": "s'il vous plaÃ®t", "meaning": "ãŠé¡˜ã„ã—ã¾ã™" }] 
      }, 
      "home_content": { 
          "pattern_focus": "Je voudrais...", "pattern_explanation": "ã€Œã€œãŒæ¬²ã—ã„ã€ã¨ä¸å¯§ã«ä¼ãˆã‚‹è¡¨ç¾ã€‚", 
          "drills": [{ "japanese": "ãŠæ°´ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚", "french": "Je voudrais de l'eau, s'il vous plaÃ®t." }, { "japanese": "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ", "french": "Je voudrais le menu." }] 
      } 
  },
  { 
      "id": "fr2", "category": "Travel", "level": "Beginner",
      "progress": { "listen": false, "speak": false },
      "commute_content": { 
          "french_text": "Excusez-moi, oÃ¹ est la station de mÃ©tro la plus proche ?", 
          "japanese_translation": "ã™ã¿ã¾ã›ã‚“ã€ä¸€ç•ªè¿‘ã„åœ°ä¸‹é‰„ã®é§…ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", 
          "chunks": "Excusez-moi, / oÃ¹ est / la station de mÃ©tro / la plus proche ?", 
          "summary": "é“ã‚’èã", 
          "vocabulary": [{ "word": "oÃ¹ est", "meaning": "ã€œã¯ã©ã“ã§ã™ã‹" }, { "word": "proche", "meaning": "è¿‘ã„" }] 
      }, 
      "home_content": { 
          "pattern_focus": "OÃ¹ est...?", "pattern_explanation": "å ´æ‰€ã‚’å°‹ã­ã‚‹åŸºæœ¬ãƒ•ãƒ¬ãƒ¼ã‚ºã€‚", 
          "drills": [{ "japanese": "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", "french": "OÃ¹ sont les toilettes ?" }, { "japanese": "å‡ºå£ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", "french": "OÃ¹ est la sortie ?" }] 
      } 
  }
];

let state = { 
    data: [], currentIndex: 0, mode: 'list', lessonTab: 'commute',
    theme: 'light', showText: false, selectedVoiceIndex: -1, voiceRate: 1.0, 
    isLooping: false, promptTopic: "Travel", promptLevel: "Beginner", promptQty: 3,
    testQueue: [], testIndex: 0 
};
let voices = [], loopInterval = null, recognition = null;

function init() {
    const savedData = localStorage.getItem('lf_data'); // Keyå¤‰æ›´: lf_data
    state.data = savedData ? JSON.parse(savedData) : defaultData;
    if (state.data.length > 0) state.data.forEach(d => { if(!d.progress) d.progress = {listen:false, speak:false}; });
    
    const restore = (k, t) => { const v = localStorage.getItem(k); if(v) state[t] = (t==='theme' || t==='selectedVoiceIndex') ? v : parseFloat(v); };
    restore('lf_theme', 'theme'); restore('lf_voice_index', 'selectedVoiceIndex'); restore('lf_voice_rate', 'voiceRate');
    
    if (state.theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition(); 
        recognition.lang = 'fr-FR'; // ãƒ•ãƒ©ãƒ³ã‚¹èªè¨­å®š
    }
    window.speechSynthesis.onvoiceschanged = loadVoices; loadVoices(); 
    render();
}

function loadVoices() {
    voices = window.speechSynthesis.getVoices(); 
    if (state.selectedVoiceIndex === -1 && voices.length) {
        // ãƒ•ãƒ©ãƒ³ã‚¹èªã®éŸ³å£°ã‚’æ¢ã™
        let idx = voices.findIndex(v => v.lang.startsWith("fr"));
        if (idx !== -1) state.selectedVoiceIndex = idx;
    }
}

// --- NAVIGATION ---
function setMode(m) { state.mode = m; stopAudio(); render(); }
function openLesson(i) { state.currentIndex = i; state.mode = 'lesson'; state.lessonTab = 'commute'; state.showText = false; stopAudio(); render(); }
function setLessonTab(t) { state.lessonTab = t; stopAudio(); render(); }
function toggleTheme() { state.theme = state.theme === 'light' ? 'dark' : 'light'; document.documentElement.setAttribute('data-theme', state.theme); localStorage.setItem('lf_theme', state.theme); render(); }
function toggleProgress(type) { state.data[state.currentIndex].progress[type] = !state.data[state.currentIndex].progress[type]; saveData(); render(); }
function saveData() { localStorage.setItem('lf_data', JSON.stringify(state.data)); }

// --- AUDIO & SPEECH ---
function speak(txt) { 
    window.speechSynthesis.cancel(); 
    const u = new SpeechSynthesisUtterance(txt); 
    u.lang = 'fr-FR'; // ãƒ•ãƒ©ãƒ³ã‚¹èªè¨­å®š
    if (voices[state.selectedVoiceIndex]) u.voice = voices[state.selectedVoiceIndex]; 
    u.rate = state.voiceRate; 
    window.speechSynthesis.speak(u); 
}
function stopAudio() { state.isLooping = false; clearInterval(loopInterval); window.speechSynthesis.cancel(); render(); }
function toggleLoop() { 
    if (state.isLooping) stopAudio(); 
    else { 
        state.isLooping = true; render(); speak(state.data[state.currentIndex].commute_content.french_text); 
        loopInterval = setInterval(() => { if (!window.speechSynthesis.speaking) speak(state.data[state.currentIndex].commute_content.french_text); }, 3000); 
    } 
}

function startDictation(target, resId, btnId) {
    if (!recognition) return alert("Mic not supported.");
    const btn = document.getElementById(btnId); const res = document.getElementById(resId);
    btn.classList.add('listening'); res.innerHTML = "Ã‰coute..."; res.classList.remove('hidden');
    recognition.start();
    recognition.onresult = (e) => {
        const input = e.results[0][0].transcript;
        const feedback = analyzeSpeech(target, input);
        res.innerHTML = feedback.html;
    };
    recognition.onend = () => btn.classList.remove('listening');
}

function analyzeSpeech(target, input) {
    // ãƒ•ãƒ©ãƒ³ã‚¹èªã¯ã‚¢ãƒã‚¹ãƒˆãƒ­ãƒ•ã‚£(l'eau)ãŒé‡è¦ãªã®ã§æ®‹ã™ãƒ­ã‚¸ãƒƒã‚¯ã«å¤‰æ›´
    const clean = (s) => s.toLowerCase().replace(/[.,?!]/g, "").split(/\s+/).filter(x => x.length > 0);
    const tWords = clean(target), iWords = clean(input);
    let html = "", matched = 0;
    tWords.forEach(w => {
        if (iWords.includes(w)) { html += `<span class="word-ok">${w}</span> `; matched++; iWords.splice(iWords.indexOf(w), 1); }
        else html += `<span class="word-miss">${w}</span> `;
    });
    const score = Math.round((matched / tWords.length) * 100);
    return { score, html: `<div style="font-weight:bold; color:${score===100?'var(--success)':'var(--accent)'}">Score: ${score}%</div>${html}<div style="font-size:0.8rem;color:gray;">Dit: "${input}"</div>` };
}

// --- TEST FUNCTION ---
function startTest() {
    const completed = state.data.filter(d => d.progress.listen || d.progress.speak);
    if (completed.length === 0) return alert("D'abord, apprenez quelques leÃ§ons !\nã¾ãšã¯å­¦ç¿’ãƒã‚§ãƒƒã‚¯ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚");
    state.testQueue = [...completed].sort(() => Math.random() - 0.5);
    state.testIndex = 0;
    state.mode = 'test';
    render();
}

// --- RENDERING ---
function render() {
    const app = document.getElementById('app-content');
    const nav = document.querySelector('.bottom-nav');
    nav.style.display = (state.mode === 'lesson' || state.mode === 'test') ? 'none' : 'flex';
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    if (state.mode === 'list') { document.getElementById('nav-list').classList.add('active'); renderList(app); }
    else if (state.mode === 'settings') { document.getElementById('nav-config').classList.add('active'); renderSettings(app); }
    else if (state.mode === 'lesson') renderLesson(app);
    else if (state.mode === 'test') { document.getElementById('nav-test').classList.add('active'); renderTest(app); }
}

function renderList(c) {
    if (state.data.length === 0) { c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--subtext)">Aucune leÃ§on.<br>Ajoutez-en dans Config !</div>'; return; }
    c.innerHTML = state.data.map((d, i) => `
        <div class="list-item" onclick="openLesson(${i})">
            <div class="list-content">
                <div class="list-summary">${d.commute_content.summary}</div>
                <div class="list-meta">
                    <span class="cat-tag cat-${d.category}">${d.category}</span>
                    <span class="level-tag">${d.level}</span>
                    <div class="progress-badges">
                        <span class="p-badge ${d.progress.listen?'done':''}">ğŸ§</span>
                        <span class="p-badge ${d.progress.speak?'done':''}">ğŸ—£ï¸</span>
                    </div>
                </div>
            </div>
            <span>â€º</span>
        </div>`).join('');
}

function renderLesson(c) {
    const d = state.data[state.currentIndex];
    const isListen = state.lessonTab === 'commute';
    c.innerHTML = `
    <div class="lesson-header"><button class="btn-outline" onclick="setMode('list')" style="width:auto;padding:5px 10px;">â† Retour</button><div style="font-weight:bold">${d.commute_content.summary}</div><div style="width:50px"></div></div>
    <div class="lesson-tabs"><div class="l-tab ${isListen?'active':''}" onclick="setLessonTab('commute')">ğŸ§ Ã‰coute</div><div class="l-tab ${!isListen?'active':''}" onclick="setLessonTab('practice')">ğŸ—£ï¸ Pratique</div></div>
    <div class="card">
        <button class="btn ${d.progress[isListen?'listen':'speak']?'btn-success':'btn-outline'}" onclick="toggleProgress('${isListen?'listen':'speak'}')">${d.progress[isListen?'listen':'speak']?'âœ… TerminÃ©':'â¬œ Marquer comme fait'}</button>
        ${isListen ? renderListenContent(d) : renderSpeakContent(d)}
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:20px">
        <button class="btn-outline" style="width:45%" onclick="if(state.currentIndex>0) openLesson(state.currentIndex-1)" ${state.currentIndex===0?'disabled':''}>â† PrÃ©c</button>
        <button class="btn-outline" style="width:45%" onclick="if(state.currentIndex<state.data.length-1) openLesson(state.currentIndex+1)" ${state.currentIndex===state.data.length-1?'disabled':''}>Suiv â†’</button>
    </div>`;
}

function renderListenContent(d) {
    return `
    <div style="margin-top:15px; display:flex; gap:10px;"><button class="btn" onclick="speak(state.data[state.currentIndex].commute_content.french_text)">â–¶ï¸ Jouer</button><button class="btn ${state.isLooping?'btn-accent':'btn-outline'}" onclick="toggleLoop()">${state.isLooping?'ğŸ” ArrÃªt':'ğŸ” Boucle'}</button></div>
    <div id="txt-area" class="${state.showText?'':'hidden'}"><div class="text-fr">${d.commute_content.french_text}</div><div class="text-jp">${d.commute_content.japanese_translation}</div><div class="chunk-view" style="margin-top:10px;border-top:1px dashed var(--border);padding-top:10px;">${d.commute_content.chunks.split('/').map(c=>`<span>${c}</span><span class="chunk-sep">/</span>`).join('')}</div></div>
    <button class="btn-outline" style="margin-top:15px;" onclick="state.showText=!state.showText;render()">${state.showText?'ğŸ™ˆ Cacher':'ğŸ‘ï¸ Montrer'} Texte</button>`;
}

function renderSpeakContent(d) {
    const safeFr = (t) => t.replace(/'/g, "\\'");
    return `
    <div class="pattern-box" style="margin-top:15px;"><div class="pattern-key">${d.home_content.pattern_focus}</div><div style="font-size:0.85rem;">${d.home_content.pattern_explanation}</div></div>
    ${d.home_content.drills.map((q, i) => `
        <div class="drill-card">
            <div style="font-weight:bold; font-size:0.9rem; margin-bottom:8px;">${i+1}. ${q.japanese}</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-mic" id="btn-mic-${i}" onclick="startDictation('${safeFr(q.french)}', 'res-${i}', 'btn-mic-${i}')" style="flex:1">ğŸ™ï¸ Parler</button>
                <button class="btn btn-accent" onclick="speak('${safeFr(q.french)}')" style="width:40px; padding:0;">ğŸ”Š</button>
                <button class="btn btn-accent" onclick="document.getElementById('ans-${i}').classList.toggle('hidden')" style="width:40px; padding:0;">ğŸ‘€</button>
            </div>
            <div id="res-${i}" class="hidden score-box"></div><div id="ans-${i}" class="hidden" style="margin-top:8px; color:var(--primary); font-weight:bold;">${q.french}</div>
        </div>`).join('')}`;
}

function renderTest(c) {
    const d = state.testQueue[state.testIndex];
    const safeFr = d.commute_content.french_text.replace(/'/g, "\\'");
    let nextBtnHTML = state.testIndex < state.testQueue.length - 1 ? `<button class="btn-outline" onclick="state.testIndex++; render()" style="flex:1">Suivant â†’</button>` : `<button class="btn-success" onclick="alert('Bravo !'); setMode('list')" style="flex:1">Finir</button>`;
    
    c.innerHTML = `
    <div class="lesson-header"><button class="btn-outline" onclick="setMode('list')" style="width:auto;padding:5px 10px;">âœ• Quitter</button><div style="font-weight:bold">Test (${state.testIndex+1}/${state.testQueue.length})</div><div style="width:50px"></div></div>
    <div class="card" style="text-align:center; padding:30px 20px;">
        <div style="color:var(--subtext); font-size:0.8rem; margin-bottom:10px;">Traduisez en franÃ§ais:</div>
        <div style="font-size:1.1rem; font-weight:bold; margin-bottom:20px;">${d.commute_content.japanese_translation}</div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
             <button class="btn btn-mic" id="btn-test-mic" onclick="startDictation('${safeFr}', 'res-test', 'btn-test-mic')" style="flex:1">ğŸ™ï¸ Parler</button>
             <button class="btn btn-accent" onclick="speak('${safeFr}')" style="width:60px;">ğŸ”Š</button>
        </div>
        <div id="res-test" class="hidden score-box" style="margin-bottom:15px;"></div>
        <div id="ans-test" class="hidden" style="padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);"><div class="text-fr" style="margin:0; font-size:1rem;">${d.commute_content.french_text}</div></div>
    </div>
    <div style="display:flex; gap:10px;"><button class="btn" onclick="document.getElementById('ans-test').classList.remove('hidden')" style="flex:1">ğŸ‘ï¸ RÃ©ponse</button>${nextBtnHTML}</div>`;
}

function updatePrompt() {
    const topic = document.getElementById('p-topic')?.value || "Travel";
    const level = document.getElementById('p-level')?.value || "Beginner";
    const qty = document.getElementById('p-qty')?.value || 3;
    const customText = document.getElementById('p-custom-text')?.value.trim() || "";
    
    let instruction = customText 
        ? `## è§£æãƒ¢ãƒ¼ãƒ‰\nä»¥ä¸‹ã®ãƒ•ãƒ©ãƒ³ã‚¹èªã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã¦ãã ã•ã„ï¼š\n"${customText}"\nã€é‡è¦ã€‘french_textã¯ä¸€å­—ä¸€å¥å¤‰ãˆãšã€å®Œç’§ã«chunksã¸åˆ†å‰²ã—ã¦ãã ã•ã„ã€‚`
        : `## ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰\nãƒ†ãƒ¼ãƒ: ${topic}\nãƒ¬ãƒ™ãƒ«: ${level}\nä½œæˆæ•°: ${qty}ã¤\nè‡ªç„¶ãªãƒ•ãƒ©ãƒ³ã‚¹èª(France)ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚`;

    const p = `ã‚ãªãŸã¯ãƒ•ãƒ©ãƒ³ã‚¹èªæ•™æä½œæˆã®ãƒ—ãƒ­ã§ã™ã€‚ä»¥ä¸‹ã®ä»•æ§˜ã§å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
${instruction}
## ã€çµ¶å¯¾éµå®ˆãƒ«ãƒ¼ãƒ«ã€‘
1. å‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã®ã¿ã€‚
2. french_text ã¨ chunks ã®é€£çµçµæœã¯å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ã“ã¨ã€‚
\`\`\`json
[
  {
    "id": "gen_${Date.now()}", 
    "category": "${topic}",
    "level": "${level}",
    "progress": { "listen": false, "speak": false },
    "commute_content": { 
      "french_text": "...", "japanese_translation": "...", "chunks": "... / ...", "summary": "...", "vocabulary": [] 
    },
    "home_content": { 
      "pattern_focus": "...", "pattern_explanation": "...", "drills": [{"japanese": "...", "french": "..."}] 
    }
  }
]
\`\`\``;
    const area = document.getElementById('p-area');
    if (area) area.value = p;
}

function copyPrompt() { updatePrompt(); navigator.clipboard.writeText(document.getElementById('p-area').value).then(() => alert('Copied!')); }
function loadJsonData() { 
    try { 
        const d = JSON.parse(document.getElementById('data-input').value); 
        if (Array.isArray(d)) { 
            if (confirm('Ajouter aux donnÃ©es existantes ?')) state.data = [...state.data, ...d]; else state.data = d; 
            saveData(); setMode('list'); 
        }
    } catch(e) { alert('Invalid JSON'); } 
}

function renderSettings(c) {
    const voiceOpts = voices.map((v,i)=>`<option value="${i}" ${i==state.selectedVoiceIndex?'selected':''}>${v.name}</option>`).join('');
    c.innerHTML = `
    <div class="card">
        <h2>ğŸ¤– AI Prompt Builder (French)</h2>
        <label>Option A: Custom Text (Paste French)</label>
        <textarea id="p-custom-text" oninput="updatePrompt()"></textarea>
        <div style="margin:15px 0; border-top:1px dashed var(--border);"></div>
        <label>Option B: Topic</label>
        <input type="text" id="p-topic" value="${state.promptTopic}" oninput="updatePrompt()">
        <div class="form-row" style="margin-top:10px;">
            <div class="form-col"><label>Level</label><select id="p-level" onchange="updatePrompt()"><option>Beginner</option><option>Intermediate</option><option>Advanced</option></select></div>
            <div class="form-col" style="flex:0 0 70px;"><label>Qty</label><input type="number" id="p-qty" value="${state.promptQty}" oninput="updatePrompt()"></div>
        </div>
        <textarea id="p-area" style="font-size:0.65rem; height:100px; margin-top:15px;" readonly></textarea>
        <button class="btn btn-outline" onclick="copyPrompt()">ğŸ“‹ Copy Prompt</button>
    </div>
    <div class="card">
        <h2>Data & Voice</h2>
        <textarea id="data-input" placeholder="Paste JSON from Gemini here..."></textarea>
        <button class="btn" onclick="loadJsonData()" style="margin-top:10px;">Load Data</button>
        <div style="margin-top:20px;"><label>Voice</label><select onchange="state.selectedVoiceIndex=this.value;localStorage.setItem('lf_voice_index',this.value)">${voiceOpts}</select></div>
        <button class="btn-outline" onclick="localStorage.removeItem('lf_data'); location.reload();" style="margin-top:20px; border-color:var(--danger); color:var(--danger);">âš ï¸ Reset All Data</button>
    </div>`;
    setTimeout(updatePrompt, 50);
}

init();
</script>
</body>
</html>
